<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management Dashboard</title>
    <!-- Bootstrap & Icons (Sesuai layout utama) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Fonts & Global CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />
    <!-- Tailwind (opsional, untuk utility kelas yang masih terpakai) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome untuk Icon tambahan -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<body class="p-8">

    <!-- 1. TOP BAR FIXED -->
    <div id="topbarContainer"></div>

    <div class="dashboard-container">
        <div id="sidebarContainer"></div>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- Header Section -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Users Management</h1>
                    <nav class="text-sm text-slate-500 flex items-center gap-2 mt-1">
                        <a href="../home.html"><i class="fas fa-home text-xs"></i></a>
                        <span>/ Settings /</span>
                        <span class="font-medium text-slate-800">Users</span>
                    </nav>
                </div>
                <div class="flex gap-3">
                    <div class="relative" id="exportDropdownWrapper">
                    <button id="exportButton" class="flex items-center gap-2 bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 transition">
                            <i class="fas fa-file-export text-slate-400"></i> Export <i class="fas fa-chevron-down text-[10px]"></i>
                        </button>
                        <div id="exportMenu" class="absolute right-0 mt-2 w-40 bg-white border border-slate-200 rounded-lg shadow-lg text-sm text-slate-700 hidden z-20">
                            <button id="exportPdf" class="w-full text-left px-4 py-2 hover:bg-slate-50">Export to PDF</button>
                            <button id="exportExcel" class="w-full text-left px-4 py-2 hover:bg-slate-50">Export to Excel</button>
                        </div>
                    </div>
                    <button id="addUserButton" class="flex items-center gap-2 btn-dlg-green text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                    <!-- <button class="bg-[#F26522] text-white p-2 rounded-lg hover:bg-orange-600 transition">
                        <i class="fas fa-angles-up"></i>
                    </button> -->
                </div>
            </div>

            <!-- Table Container -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                
                <!-- Filter Bar -->
                <div class="p-5 border-b border-slate-100">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <h2 class="font-bold text-slate-800">Users List</h2>
                        <div class="flex gap-3 flex-wrap">
                            <div class="relative">
                                <select id="filterDatePreset" class="appearance-none bg-white border border-slate-200 pl-4 pr-10 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="last90">Last 90 Days</option>
                                    <option value="last30">Last 30 Days</option>
                                    <option value="last60">Last 60 Days</option>
                                    <option value="last6month">Last 6 Month</option>
                                    <option value="thisYear">This Year</option>
                                    <option value="lastYear">Last Year</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-3 text-[10px] text-slate-400"></i>
                            </div>
                            <div class="relative">
                                <select id="filterRole" class="appearance-none bg-white border border-slate-200 pl-4 pr-10 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="">All Role</option>
                                    <option value="Super Team">Super Team</option>
                                    <option value="Sub Team">Sub Team</option>
                                    <option value="Mentor">Mentor</option>
                                    <option value="Employee">Employee</option>
                                    <option value="Internship">Internship</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-3 text-[10px] text-slate-400"></i>
                            </div>
                            <div class="relative">
                                <select id="filterStatus" class="appearance-none bg-white border border-slate-200 pl-4 pr-10 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-3 text-[10px] text-slate-400"></i>
                            </div>
                            <div class="relative">
                                <select id="filterSort" class="appearance-none bg-white border border-slate-200 pl-4 pr-10 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="recent">Recently Add</option>
                                    <option value="nameAsc">Name Ascending</option>
                                    <option value="nameDesc">Name Descending</option>
                                    <option value="last7">Last 7 Days</option>
                                    <option value="lastMonth">Last Month</option>
                                    <option value="last3month">Last 3 Months</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-3 top-3 text-[10px] text-slate-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search & Row Per Page -->
                <div class="p-5 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-sm text-slate-600">
                        Row Per Page 
                        <select id="rowsPerPage" class="bg-white border border-slate-200 px-2 py-1 rounded-md focus:outline-none">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                        Entries
                    </div>
                    <div class="relative">
                        <input id="searchInput" type="text" placeholder="Search" class="border border-slate-200 pl-4 pr-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 w-64">
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left">
                        <thead class="bg-slate-50 text-slate-600 text-sm font-semibold border-y border-slate-100">
                            <tr>
                                <th class="px-6 py-4 w-10 sticky left-0 bg-slate-50 z-20">
                                    <input id="selectAllCheckbox" type="checkbox" class="rounded text-orange-500">
                                </th>
                                <th id="thName" class="px-6 py-4 cursor-pointer select-none sticky left-10 bg-slate-50 z-10">
                                    <span class="inline-flex items-center gap-2 whitespace-nowrap">
                                        Name <i class="fas fa-sort text-slate-300"></i>
                                    </span>
                                </th>
                                <th id="thEmail" class="px-6 py-4 cursor-pointer select-none">
                                    <span class="inline-flex items-center gap-2 whitespace-nowrap">
                                        Email <i class="fas fa-sort text-slate-300"></i>
                                    </span>
                                </th>
                                <th id="thCreated" class="px-6 py-4 cursor-pointer select-none">
                                    <span class="inline-flex items-center gap-2 whitespace-nowrap">
                                        Created <i class="fas fa-sort text-slate-300"></i>
                                    </span>
                                </th>
                                <th id="thPosition" class="px-6 py-4 text-center cursor-pointer select-none">
                                    <span class="inline-flex items-center gap-2 whitespace-nowrap">
                                        Position <i class="fas fa-sort text-slate-300"></i>
                                    </span>
                                </th>
                                <th id="thRole" class="px-6 py-4 text-center cursor-pointer select-none">
                                    <span class="inline-flex items-center gap-2 whitespace-nowrap">
                                        Role <i class="fas fa-sort text-slate-300"></i>
                                    </span>
                                </th>
                                <th id="thStatus" class="px-6 py-4 text-center cursor-pointer select-none">
                                    <span class="inline-flex items-center gap-2 whitespace-nowrap">
                                        Status <i class="fas fa-sort text-slate-300"></i>
                                    </span>
                                </th>
                                <th class="px-6 py-4 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="text-sm divide-y divide-slate-100">
                            <!-- Row 1 -->
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4 sticky left-0 bg-white z-10"><input type="checkbox" class="rounded"></td>
                                <td class="px-6 py-4 flex items-center gap-3 sticky left-10 bg-white z-10">
                                    <img src="https://i.pravatar.cc/150?u=1" class="w-10 h-10 rounded-full object-cover">
                                    <span class="font-semibold text-slate-800">Anthony Lewis</span>
                                </td>
                                <td class="px-6 py-4 text-slate-500">anthony@example.com</td>
                                <td class="px-6 py-4 text-slate-500">12 Sep 2024</td>
                                <td class="px-6 py-4 text-start">
                                    <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">Senior</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-pink-100 text-pink-600 px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">Employee</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-green-500 text-white px-3 py-1 rounded-md text-[10px] font-medium whitespace-nowrap">
                                        <i class="fas fa-circle text-[3px] mr-1"></i> Active
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end gap-3 text-slate-400">
                                        <button class="hover:text-slate-600"><i class="fas fa-shield-halved"></i></button>
                                        <button class="hover:text-blue-500"><i class="fas fa-pen"></i></button>
                                        <button class="hover:text-red-500"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Row 2 -->
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4 sticky left-0 bg-white z-10"><input type="checkbox" class="rounded"></td>
                                <td class="px-6 py-4 flex items-center gap-3 sticky left-10 bg-white z-10">
                                    <img src="https://i.pravatar.cc/150?u=2" class="w-10 h-10 rounded-full object-cover">
                                    <span class="font-semibold text-slate-800">Sophie Headrick</span>
                                </td>
                                <td class="px-6 py-4 text-slate-500">sophie@example.com</td>
                                <td class="px-6 py-4 text-slate-500">18 Feb 2024</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">Lead</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-purple-100 text-purple-600 px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">Client</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-green-500 text-white px-3 py-1 rounded-md text-[10px] font-medium whitespace-nowrap">
                                        <i class="fas fa-circle text-[3px] mr-1"></i> Active
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end gap-3 text-slate-400">
                                        <button class="hover:text-slate-600"><i class="fas fa-shield-halved"></i></button>
                                        <button class="hover:text-blue-500"><i class="fas fa-pen"></i></button>
                                        <button class="hover:text-red-500"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Row 3 (Inactive) -->
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4 sticky left-0 bg-white z-10"><input type="checkbox" class="rounded"></td>
                                <td class="px-6 py-4 flex items-center gap-3 sticky left-10 bg-white z-10">
                                    <img src="https://i.pravatar.cc/150?u=8" class="w-10 h-10 rounded-full object-cover">
                                    <span class="font-semibold text-slate-800">Harvey Smith</span>
                                </td>
                                <td class="px-6 py-4 text-slate-500">harvey@example.com</td>
                                <td class="px-6 py-4 text-slate-500">22 Feb 2024</td>
                                <td class="px-6 py-4 text-start">
                                    <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">Intern</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-pink-100 text-pink-600 px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">Employee</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-red-500 text-white px-3 py-1 rounded-md text-[10px] font-medium whitespace-nowrap">
                                        <i class="fas fa-circle text-[3px] mr-1"></i> Inactive
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end gap-3 text-slate-400">
                                        <button class="hover:text-slate-600"><i class="fas fa-shield-halved"></i></button>
                                        <button class="hover:text-blue-500"><i class="fas fa-pen"></i></button>
                                        <button class="hover:text-red-500"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Footer / Pagination -->
                <div class="p-5 border-t border-slate-100 flex justify-between items-center text-sm">
                    <p id="paginationText" class="text-slate-500 font-medium">Showing 1 - 10 of 10 entries</p>
                    <div class="flex items-center gap-1">
                        <button id="prevPage" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600"><i class="fas fa-chevron-left text-xs"></i></button>
                        <button class="w-8 h-8 flex items-center justify-center btn-dlg-blue text-white rounded-full font-bold">1</button>
                        <button id="nextPage" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600"><i class="fas fa-chevron-right text-xs"></i></button>
                    </div>
                </div>
            </div>

            <div id="customRangeOverlay" class="fixed inset-0 bg-black/40 flex items-center justify-center z-30 hidden">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-slate-800">Custom Range</h3>
                        <p class="text-xs text-slate-500 mt-1">Pilih tanggal mulai dan tanggal akhir</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Start Date</label>
                            <input id="customStartDate" type="date" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">End Date</label>
                            <input id="customEndDate" type="date" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="customRangeCancel" class="px-4 py-2 rounded-lg text-sm text-slate-600 hover:bg-slate-100">Cancel</button>
                        <button id="customRangeApply" class="px-4 py-2 rounded-lg text-sm bg-[#F26522] text-white hover:bg-orange-600">Apply</button>
                    </div>
                </div>
            </div>

            <div id="editUserOverlay" class="fixed inset-0 bg-black/40 flex items-center justify-center z-40 hidden">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-slate-800">Edit User</h3>
                        <button id="editUserClose" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Full Name</label>
                            <input id="editFullName" type="text" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Position</label>
                            <select id="editPosition" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Nickname</label>
                            <input id="editNickname" type="text" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Email</label>
                            <input id="editEmail" type="email" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Password</label>
                            <div class="relative">
                                <input id="editPassword" type="password" class="w-full border border-slate-200 rounded-lg px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <button type="button" id="toggleEditPassword" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Status</label>
                            <select id="editStatus" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Phone</label>
                            <input id="editPhone" type="text" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Role</label>
                            <select id="editRole" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"></select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button id="editUserCancel" class="px-4 py-2 rounded-lg text-sm text-slate-600 hover:bg-slate-100">Cancel</button>
                        <button id="editUserSave" class="px-4 py-2 rounded-lg btn-dlg-green text-white ">Save</button>
                    </div>
                </div>
            </div>

            <div id="addUserOverlay" class="fixed inset-0 bg-black/40 flex items-center justify-center z-40 hidden">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-slate-800">Add User</h3>
                        <button id="addUserClose" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Full Name</label>
                            <input id="addFullName" type="text" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Position</label>
                            <select id="addPosition" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Nickname</label>
                            <input id="addNickname" type="text" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Email</label>
                            <input id="addEmail" type="email" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Password</label>
                            <div class="relative">
                                <input id="addPassword" type="password" class="w-full border border-slate-200 rounded-lg px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <button type="button" id="toggleAddPassword" class="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Status</label>
                            <select id="addStatus" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Phone</label>
                            <input id="addPhone" type="text" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Role</label>
                            <select id="addRole" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"></select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button id="addUserCancel" class="px-4 py-2 rounded-lg text-sm text-slate-600 hover:bg-slate-100">Cancel</button>
                        <button id="addUserSave" class="px-4 py-2 rounded-lg text-sm bg-[#F26522] text-white hover:bg-orange-600">Save</button>
                    </div>
                </div>
            </div>

            <div id="deleteUserOverlay" class="fixed inset-0 bg-black/40 flex items-center justify-center z-40 hidden">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
                    <div class="mx-auto mb-4 w-14 h-14 rounded-xl bg-red-50 flex items-center justify-center">
                        <i class="fas fa-trash text-red-500 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-1">Confirm Delete</h3>
                    <p class="text-sm text-slate-600 mb-6">
                        You want to delete all the marked items, this cant be undone once you delete.
                    </p>
                    <div class="flex justify-center gap-3">
                        <button id="deleteUserCancel" class="px-4 py-2 rounded-lg text-sm text-slate-600 border border-slate-200 hover:bg-slate-50">
                            Cancel
                        </button>
                        <button id="deleteUserConfirm" class="px-4 py-2 rounded-lg text-sm bg-red-500 text-white hover:bg-red-600">
                            Yes, Delete
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { renderTopBar } from "../element/topbar.js";
        import { renderSidebar } from "../element/sidebar.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            getDocs,
            collection,
            query,
            where,
            addDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com", 
            projectId: "pre-dialogika", 
            storageBucket: "pre-dialogika.firebasestorage.app", 
            messagingSenderId: "343771410480", 
            appId: "1:343771410480:web:32881c9868522090237df5", 
            measurementId: "G-SXN811P3N0" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.serverTimestamp = serverTimestamp;

        const topbarTarget = document.getElementById('topbarContainer');
        renderTopBar(topbarTarget);

        const sidebarTarget = document.getElementById('sidebarContainer');
        renderSidebar(sidebarTarget);

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebarNav');
            if (sidebar) sidebar.classList.toggle('show');
        };

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
                return;
            }
            loadUsers();
        });

        const rolesOrder = ["Super Team", "Sub Team", "Mentor", "Employee", "Internship"];
        const statusOrder = ["Active", "Inactive"];
        let allUsers = [];
        let rolesCache = null;
        let positionsCache = null;
        let editingUserId = null;
        let deletingUserId = null;
        let addingUser = false;

        async function fetchUsersFromFirestore() {
            try {
                if (!rolesCache) {
                    const rolesSnap = await getDocs(collection(db, "roles"));
                    const rolesMap = {};
                    rolesSnap.forEach(roleDoc => {
                        const r = roleDoc.data() || {};
                        const key = roleDoc.id;
                        const label = r.name || r.label || r.title || key;
                        rolesMap[key] = label;
                    });
                    rolesCache = rolesMap;
                }

                if (!positionsCache) {
                    await ensurePositionsCache();
                }

                const snap = await getDocs(collection(db, "users"));
                const users = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    let createdDate = null;
                    if (data.createdAt && typeof data.createdAt.toDate === "function") {
                        createdDate = data.createdAt.toDate();
                    } else if (data.createdAt) {
                        const tmp = new Date(data.createdAt);
                        if (!isNaN(tmp.getTime())) {
                            createdDate = tmp;
                        }
                    }
                    let createdStr = "";
                    if (createdDate && !isNaN(createdDate.getTime())) {
                        const y = createdDate.getFullYear();
                        const m = String(createdDate.getMonth() + 1).padStart(2, "0");
                        const d = String(createdDate.getDate()).padStart(2, "0");
                        createdStr = `${y}-${m}-${d}`;
                    }

                    const rawRole = data.role || "";
                    let resolvedRole = "";
                    if (rawRole) {
                        if (rolesCache[rawRole]) {
                            resolvedRole = rolesCache[rawRole];
                        } else {
                            resolvedRole = rawRole;
                        }
                    }
                    if (!resolvedRole) resolvedRole = "Employee";

                    const rawPositionKey = data.position || (data.employment && data.employment.position) || "";
                    let resolvedPosition = rawPositionKey;
                    if (rawPositionKey && positionsCache && positionsCache[rawPositionKey]) {
                        resolvedPosition = positionsCache[rawPositionKey];
                    }

                    users.push({
                        id: docSnap.id,
                        name: data.name || data.email || "Unknown",
                        nickname: data.nickname || data.username || data.userName || "",
                        email: data.email || "",
                        created: createdStr,
                        position: resolvedPosition || "",
                        role: resolvedRole,
                        status: data.status || "Active",
                        avatar: data.photo || `https://i.pravatar.cc/150?u=${docSnap.id}`
                    });
                });
                return users;
            } catch (e) {
                console.error("Error fetching users from Firestore", e);
                return [];
            }
        }

        async function loadUsers() {
            const users = await fetchUsersFromFirestore();
            allUsers = users;
            renderTable();
        }

        const state = {
            search: "",
            datePreset: "last90",
            role: "",
            status: "",
            sort: "recent",
            rowsPerPage: 25,
            page: 1,
            customStart: null,
            customEnd: null,
            sortDirName: "asc",
            sortDirEmail: "asc",
            sortDirCreated: "desc",
            sortDirPosition: "asc",
            sortDirRole: "asc",
            sortDirStatus: "asc"
        };

        function parseISO(dateStr) {
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function applyDatePreset(preset, data) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            if (preset === "custom" && state.customStart && state.customEnd) {
                const start = parseISO(state.customStart);
                const end = parseISO(state.customEnd);
                if (!start || !end) return data;
                return data.filter(u => {
                    const d = parseISO(u.created);
                    if (!d) return true;
                    return d >= start && d <= end;
                });
            }
            function offsetDays(days) {
                return new Date(today.getTime() - days * 86400000);
            }
            function firstDayOfYear(year) {
                return new Date(year, 0, 1);
            }
            function lastDayOfYear(year) {
                return new Date(year, 11, 31);
            }
            let start = null;
            let end = today;
            if (preset === "last30") start = offsetDays(30);
            else if (preset === "last60") start = offsetDays(60);
            else if (preset === "last90") start = offsetDays(90);
            else if (preset === "last6month") start = offsetDays(180);
            else if (preset === "thisYear") {
                start = firstDayOfYear(today.getFullYear());
                end = lastDayOfYear(today.getFullYear());
            } else if (preset === "lastYear") {
                const y = today.getFullYear() - 1;
                start = firstDayOfYear(y);
                end = lastDayOfYear(y);
            } else if (preset === "last7" || preset === "lastMonth" || preset === "last3month") {
                if (preset === "last7") start = offsetDays(7);
                if (preset === "lastMonth") start = offsetDays(30);
                if (preset === "last3month") start = offsetDays(90);
            } else {
                return data;
            }
            return data.filter(u => {
                const d = parseISO(u.created);
                if (!d) return true;
                return d >= start && d <= end;
            });
        }

        function sortData(data) {
            const sort = state.sort;
            const copy = [...data];
            if (sort === "recent") {
                copy.sort((a, b) => parseISO(b.created) - parseISO(a.created));
            } else if (sort === "nameAsc" || sort === "nameDesc") {
                copy.sort((a, b) => {
                    const na = a.name.toLowerCase();
                    const nb = b.name.toLowerCase();
                    if (na < nb) return sort === "nameAsc" ? -1 : 1;
                    if (na > nb) return sort === "nameAsc" ? 1 : -1;
                    return 0;
                });
            } else if (sort === "last7" || sort === "lastMonth" || sort === "last3month") {
                copy.sort((a, b) => parseISO(b.created) - parseISO(a.created));
            }
            return copy;
        }

        function sortByColumn(data, column, direction) {
            const copy = [...data];
            if (column === "name" || column === "email") {
                copy.sort((a, b) => {
                    const av = a[column].toLowerCase();
                    const bv = b[column].toLowerCase();
                    if (av < bv) return direction === "asc" ? -1 : 1;
                    if (av > bv) return direction === "asc" ? 1 : -1;
                    return 0;
                });
            } else if (column === "created") {
                copy.sort((a, b) => {
                    const av = parseISO(a.created);
                    const bv = parseISO(b.created);
                    return direction === "asc" ? av - bv : bv - av;
                });
            } else if (column === "position") {
                copy.sort((a, b) => {
                    const av = (a.position || "").toLowerCase();
                    const bv = (b.position || "").toLowerCase();
                    if (av < bv) return direction === "asc" ? -1 : 1;
                    if (av > bv) return direction === "asc" ? 1 : -1;
                    return 0;
                });
            } else if (column === "role") {
                copy.sort((a, b) => {
                    const ia = rolesOrder.indexOf(a.role);
                    const ib = rolesOrder.indexOf(b.role);
                    return direction === "asc" ? ia - ib : ib - ia;
                });
            } else if (column === "status") {
                copy.sort((a, b) => {
                    const ia = statusOrder.indexOf(a.status);
                    const ib = statusOrder.indexOf(b.status);
                    return direction === "asc" ? ia - ib : ib - ia;
                });
            }
            return copy;
        }

        function getFilteredData() {
            let data = [...allUsers];
            if (state.search) {
                const q = state.search.toLowerCase();
                data = data.filter(u => {
                    const displayName = (u.nickname || u.name || "").toLowerCase();
                    return displayName.includes(q) || u.email.toLowerCase().includes(q);
                });
            }
            if (state.role) {
                data = data.filter(u => u.role === state.role);
            }
            if (state.status) {
                data = data.filter(u => u.status === state.status);
            }
            data = applyDatePreset(state.datePreset, data);
            if (state.sort === "last7" || state.sort === "lastMonth" || state.sort === "last3month") {
                data = applyDatePreset(state.sort, data);
            }
            data = sortData(data);
            return data;
        }

        function getRoleBadgeClass(role) {
            const r = (role || "").toLowerCase();
            if (r.includes("super")) return "bg-indigo-100 text-indigo-600";
            if (r.includes("sub")) return "bg-teal-100 text-teal-600";
            if (r.includes("mentor")) return "bg-amber-100 text-amber-600";
            if (r.includes("intern")) return "bg-slate-100 text-slate-600";
            if (r.includes("employee") || r.includes("staff")) return "bg-pink-100 text-pink-600";
            return "bg-sky-100 text-sky-600";
        }

        function renderTable() {
            const tbody = document.getElementById("usersTableBody");
            const paginationText = document.getElementById("paginationText");
            const prevBtn = document.getElementById("prevPage");
            const nextBtn = document.getElementById("nextPage");
            if (!tbody || !paginationText || !prevBtn || !nextBtn) return;
            const filtered = getFilteredData();
            const total = filtered.length;
            const perPage = state.rowsPerPage;
            const totalPages = Math.max(1, Math.ceil(total / perPage));
            if (state.page > totalPages) state.page = totalPages;
            const startIndex = (state.page - 1) * perPage;
            const endIndex = Math.min(startIndex + perPage, total);
            const pageItems = filtered.slice(startIndex, endIndex);
            tbody.innerHTML = "";
            pageItems.forEach(u => {
                const displayName = u.nickname || u.name;
                const tr = document.createElement("tr");
                tr.className = "hover:bg-slate-50 transition";
                tr.setAttribute("data-user-id", u.id);
                const createdDate = parseISO(u.created);
                const createdDisplay = createdDate ? createdDate.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" }) : "-";
                const roleBadgeClass = getRoleBadgeClass(u.role);
                tr.innerHTML = `
                    <td class="px-6 py-4 sticky left-0 bg-white z-10">
                        <input type="checkbox" class="row-checkbox rounded">
                    </td>
                    <td class="px-6 py-4 flex items-center gap-3 sticky left-10 bg-white z-10">
                        <img src="${u.avatar}" class="w-10 h-10 rounded-full object-cover">
                        <span class="font-semibold text-slate-800">${displayName}</span>
                    </td>
                    <td class="px-6 py-4 text-slate-500">${u.email}</td>
                    <td class="px-6 py-4 text-slate-500">${createdDisplay}</td>
                    <td class="px-6 py-4 text-start">
                        <span class="px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">${u.position || "-"}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="${roleBadgeClass} px-3 py-1 rounded-md text-xs font-bold whitespace-nowrap">${u.role}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="${u.status === "Active" ? "bg-green-500" : "bg-red-500"} text-white px-3 py-1 rounded-md text-[10px] font-medium whitespace-nowrap">
                            <i class="fas fa-circle text-[3px] mr-1"></i> ${u.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-3 text-slate-400">
                            <button class="hover:text-slate-600"><i class="fas fa-shield-halved"></i></button>
                            <button class="hover:text-blue-500 edit-user-btn"><i class="fas fa-pen"></i></button>
                            <button class="hover:text-red-500 delete-user-btn"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            if (total === 0) {
                paginationText.textContent = "Showing 0 entries";
            } else {
                paginationText.textContent = `Showing ${startIndex + 1} - ${endIndex} of ${total} entries`;
            }
            prevBtn.disabled = state.page <= 1;
            nextBtn.disabled = state.page >= totalPages;
            prevBtn.classList.toggle("opacity-40", prevBtn.disabled);
            nextBtn.classList.toggle("opacity-40", nextBtn.disabled);
            const selectAll = document.getElementById("selectAllCheckbox");
            if (selectAll) selectAll.checked = false;
        }

        async function ensureRolesCache() {
            if (rolesCache) return;
            const snap = await getDocs(collection(db, "roles"));
            const map = {};
            snap.forEach(d => {
                const r = d.data() || {};
                const key = d.id;
                const label = r.name || r.label || r.title || key;
                map[key] = label;
            });
            rolesCache = map;
        }

        async function ensurePositionsCache() {
            if (positionsCache) return;
            let snap = await getDocs(collection(db, "position"));
            if (snap.empty) {
                try {
                    const altSnap = await getDocs(collection(db, "positions"));
                    snap = altSnap;
                } catch (e) {
                    console.warn("Fallback positions collection 'positions' not readable", e);
                }
            }
            const map = {};
            snap.forEach(d => {
                const r = d.data() || {};
                const key = d.id;
                const label = r.name || r.label || r.title || r.position || key;
                map[key] = label;
            });
            positionsCache = map;
            console.log("Loaded positionsCache keys:", Object.keys(positionsCache));
        }

        async function openEditUserModal(userId) {
            try {
                await ensureRolesCache();
                await ensurePositionsCache();
                const overlay = document.getElementById("editUserOverlay");
                const fullNameInput = document.getElementById("editFullName");
                const nicknameInput = document.getElementById("editNickname");
                const emailInput = document.getElementById("editEmail");
                const phoneInput = document.getElementById("editPhone");
                const positionSelect = document.getElementById("editPosition");
                const roleSelect = document.getElementById("editRole");
                const passwordInput = document.getElementById("editPassword");
                const statusSelect = document.getElementById("editStatus");
                if (!overlay || !fullNameInput || !nicknameInput || !emailInput || !phoneInput || !positionSelect || !roleSelect || !passwordInput || !statusSelect) return;

                positionSelect.innerHTML = "";
                const posDefault = document.createElement("option");
                posDefault.value = "";
                posDefault.textContent = "Select position";
                positionSelect.appendChild(posDefault);
                Object.keys(positionsCache || {}).forEach(key => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = positionsCache[key];
                    positionSelect.appendChild(opt);
                });

                roleSelect.innerHTML = "";
                const roleDefault = document.createElement("option");
                roleDefault.value = "";
                roleDefault.textContent = "Select role";
                roleSelect.appendChild(roleDefault);
                Object.keys(rolesCache || {}).forEach(key => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = rolesCache[key];
                    roleSelect.appendChild(opt);
                });

                const userDoc = await getDoc(doc(db, "users", userId));
                if (!userDoc.exists()) return;
                const data = userDoc.data() || {};
                editingUserId = userId;

                fullNameInput.value = data.name || "";
                nicknameInput.value = data.nickname || data.username || data.userName || "";
                emailInput.value = data.email || "";
                phoneInput.value = data.phone || data.phoneNumber || "";
                const currentPositionKey = data.position || (data.employment && data.employment.position) || "";
                positionSelect.value = currentPositionKey || "";
                const currentRoleKey = data.role || "";
                roleSelect.value = currentRoleKey || "";
                passwordInput.value = "";
                const currentStatus = data.status || "Active";
                statusSelect.value = currentStatus;

                overlay.classList.remove("hidden");
            } catch (e) {
                console.error("Failed to open edit user modal", e);
            }
        }

        async function openAddUserModal() {
            try {
                await ensureRolesCache();
                await ensurePositionsCache();
                const overlay = document.getElementById("addUserOverlay");
                const fullNameInput = document.getElementById("addFullName");
                const nicknameInput = document.getElementById("addNickname");
                const emailInput = document.getElementById("addEmail");
                const phoneInput = document.getElementById("addPhone");
                const positionSelect = document.getElementById("addPosition");
                const roleSelect = document.getElementById("addRole");
                const passwordInput = document.getElementById("addPassword");
                const statusSelect = document.getElementById("addStatus");
                if (!overlay || !fullNameInput || !nicknameInput || !emailInput || !phoneInput || !positionSelect || !roleSelect || !passwordInput || !statusSelect) return;

                positionSelect.innerHTML = "";
                const posDefault = document.createElement("option");
                posDefault.value = "";
                posDefault.textContent = "Select position";
                positionSelect.appendChild(posDefault);
                Object.keys(positionsCache || {}).forEach(key => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = positionsCache[key];
                    positionSelect.appendChild(opt);
                });

                roleSelect.innerHTML = "";
                const roleDefault = document.createElement("option");
                roleDefault.value = "";
                roleDefault.textContent = "Select role";
                roleSelect.appendChild(roleDefault);
                Object.keys(rolesCache || {}).forEach(key => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = rolesCache[key];
                    roleSelect.appendChild(opt);
                });

                fullNameInput.value = "";
                nicknameInput.value = "";
                emailInput.value = "";
                phoneInput.value = "";
                positionSelect.value = "";
                roleSelect.value = "";
                passwordInput.value = "";
                statusSelect.value = "Active";
                addingUser = true;
                overlay.classList.remove("hidden");
            } catch (e) {
                console.error("Failed to open add user modal", e);
            }
        }

        async function saveAddUser() {
            const overlay = document.getElementById("addUserOverlay");
            const fullNameInput = document.getElementById("addFullName");
            const nicknameInput = document.getElementById("addNickname");
            const emailInput = document.getElementById("addEmail");
            const phoneInput = document.getElementById("addPhone");
            const positionSelect = document.getElementById("addPosition");
            const roleSelect = document.getElementById("addRole");
            const passwordInput = document.getElementById("addPassword");
            const statusSelect = document.getElementById("addStatus");
            if (!overlay || !fullNameInput || !nicknameInput || !emailInput || !phoneInput || !positionSelect || !roleSelect || !passwordInput || !statusSelect) return;
            const name = fullNameInput.value.trim();
            const email = emailInput.value.trim();
            if (!name || !email) {
                alert("Nama dan email wajib diisi.");
                return;
            }
            const payload = {
                name: name,
                email: email,
                phone: phoneInput.value || "",
                nickname: nicknameInput.value || "",
                role: roleSelect.value || "",
                position: positionSelect.value || "",
                status: statusSelect.value || "Active",
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, "users"), payload);
                overlay.classList.add("hidden");
                addingUser = false;
                await loadUsers();
            } catch (e) {
                console.error("Failed to add user", e);
                alert("Gagal menambah user.");
            }
        }

        async function saveEditUser() {
            const overlay = document.getElementById("editUserOverlay");
            const fullNameInput = document.getElementById("editFullName");
            const nicknameInput = document.getElementById("editNickname");
            const emailInput = document.getElementById("editEmail");
            const phoneInput = document.getElementById("editPhone");
            const positionSelect = document.getElementById("editPosition");
            const roleSelect = document.getElementById("editRole");
            const passwordInput = document.getElementById("editPassword");
            const statusSelect = document.getElementById("editStatus");
            if (!overlay || !fullNameInput || !nicknameInput || !emailInput || !phoneInput || !positionSelect || !roleSelect || !passwordInput || !statusSelect) return;
            if (!editingUserId) return;
            const newPass = passwordInput.value || "";
            if (newPass) {
                if (auth.currentUser && auth.currentUser.uid === editingUserId) {
                    try {
                        await updatePassword(auth.currentUser, newPass);
                    } catch (e) {
                        alert("Gagal mengganti password: " + (e && e.message ? e.message : e));
                        return;
                    }
                } else {
                    alert("Password hanya bisa diganti untuk akun yang sedang login.");
                }
            }
            const payload = {
                name: fullNameInput.value || "",
                email: emailInput.value || "",
                phone: phoneInput.value || "",
                nickname: nicknameInput.value || "",
                role: roleSelect.value || "",
                position: positionSelect.value || "",
                status: statusSelect.value || "Active"
            };
            try {
                await updateDoc(doc(db, "users", editingUserId), payload);
                overlay.classList.add("hidden");
                editingUserId = null;
                await loadUsers();
            } catch (e) {
                console.error("Failed to update user", e);
                alert("Gagal menyimpan perubahan user.");
            }
        }

        function setupControls() {
            const searchInput = document.getElementById("searchInput");
            const filterDatePreset = document.getElementById("filterDatePreset");
            const filterRole = document.getElementById("filterRole");
            const filterStatus = document.getElementById("filterStatus");
            const filterSort = document.getElementById("filterSort");
            const rowsPerPage = document.getElementById("rowsPerPage");
            const prevBtn = document.getElementById("prevPage");
            const nextBtn = document.getElementById("nextPage");
            const selectAll = document.getElementById("selectAllCheckbox");
            const thName = document.getElementById("thName");
            const thEmail = document.getElementById("thEmail");
            const thCreated = document.getElementById("thCreated");
            const thPosition = document.getElementById("thPosition");
            const thRole = document.getElementById("thRole");
            const thStatus = document.getElementById("thStatus");
            const exportBtn = document.getElementById("exportButton");
            const exportMenu = document.getElementById("exportMenu");
            const exportWrapper = document.getElementById("exportDropdownWrapper");
            const exportPdf = document.getElementById("exportPdf");
            const exportExcel = document.getElementById("exportExcel");
            const customOverlay = document.getElementById("customRangeOverlay");
            const customStart = document.getElementById("customStartDate");
            const customEnd = document.getElementById("customEndDate");
            const customApply = document.getElementById("customRangeApply");
            const customCancel = document.getElementById("customRangeCancel");
            const editOverlay = document.getElementById("editUserOverlay");
            const editClose = document.getElementById("editUserClose");
            const editCancel = document.getElementById("editUserCancel");
            const editSave = document.getElementById("editUserSave");
            const togglePass = document.getElementById("toggleEditPassword");
            const deleteOverlay = document.getElementById("deleteUserOverlay");
            const deleteCancel = document.getElementById("deleteUserCancel");
            const deleteConfirm = document.getElementById("deleteUserConfirm");
            const addButton = document.getElementById("addUserButton");
            const addOverlay = document.getElementById("addUserOverlay");
            const addClose = document.getElementById("addUserClose");
            const addCancel = document.getElementById("addUserCancel");
            const addSave = document.getElementById("addUserSave");
            const toggleAddPass = document.getElementById("toggleAddPassword");

            if (searchInput) {
                searchInput.addEventListener("input", e => {
                    state.search = e.target.value || "";
                    state.page = 1;
                    renderTable();
                });
            }
            if (filterDatePreset) {
                filterDatePreset.addEventListener("change", e => {
                    const val = e.target.value;
                    state.datePreset = val;
                    if (val === "custom") {
                        if (customOverlay && customStart && customEnd) {
                            const today = new Date();
                            const y = today.getFullYear();
                            const m = String(today.getMonth() + 1).padStart(2, "0");
                            const d = String(today.getDate()).padStart(2, "0");
                            const startDefault = `${y}-${m}-01`;
                            const endDefault = `${y}-${m}-${d}`;
                            customStart.value = state.customStart || startDefault;
                            customEnd.value = state.customEnd || endDefault;
                            customOverlay.classList.remove("hidden");
                        }
                    } else {
                        state.page = 1;
                        renderTable();
                    }
                });
            }
            if (filterRole) {
                filterRole.addEventListener("change", e => {
                    state.role = e.target.value || "";
                    state.page = 1;
                    renderTable();
                });
            }
            if (filterStatus) {
                filterStatus.addEventListener("change", e => {
                    state.status = e.target.value || "";
                    state.page = 1;
                    renderTable();
                });
            }
            if (filterSort) {
                filterSort.addEventListener("change", e => {
                    state.sort = e.target.value || "recent";
                    state.page = 1;
                    renderTable();
                });
            }
            if (rowsPerPage) {
                rowsPerPage.addEventListener("change", e => {
                    const v = parseInt(e.target.value, 10);
                    state.rowsPerPage = isNaN(v) ? 25 : v;
                    state.page = 1;
                    renderTable();
                });
            }
            if (prevBtn) {
                prevBtn.addEventListener("click", () => {
                    if (state.page > 1) {
                        state.page -= 1;
                        renderTable();
                    }
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener("click", () => {
                    state.page += 1;
                    renderTable();
                });
            }
            if (selectAll) {
                selectAll.addEventListener("change", e => {
                    const checked = e.target.checked;
                    const checkboxes = document.querySelectorAll(".row-checkbox");
                    checkboxes.forEach(cb => {
                        cb.checked = checked;
                    });
                });
            }

            const usersTbody = document.getElementById("usersTableBody");
            if (usersTbody) {
                usersTbody.addEventListener("click", e => {
                    const editBtn = e.target.closest(".edit-user-btn");
                    const deleteBtn = e.target.closest(".delete-user-btn");
                    if (!editBtn && !deleteBtn) return;
                    const row = e.target.closest("tr");
                    if (!row) return;
                    const userId = row.getAttribute("data-user-id");
                    if (!userId) return;
                    if (editBtn) {
                        openEditUserModal(userId);
                    } else if (deleteBtn && deleteOverlay) {
                        deletingUserId = userId;
                        deleteOverlay.classList.remove("hidden");
                    }
                });
            }
            function setupHeaderSort(th, column, dirKey) {
                if (!th) return;
                th.addEventListener("click", () => {
                    const current = state[dirKey];
                    const nextDir = current === "asc" ? "desc" : "asc";
                    state[dirKey] = nextDir;
                    let data = getFilteredData();
                    data = sortByColumn(data, column, nextDir);
                    const tbody = document.getElementById("usersTableBody");
                    if (!tbody) return;
                    const perPage = state.rowsPerPage;
                    const total = data.length;
                    const totalPages = Math.max(1, Math.ceil(total / perPage));
                    if (state.page > totalPages) state.page = totalPages;
                    const startIndex = (state.page - 1) * perPage;
                    const endIndex = Math.min(startIndex + perPage, total);
                    const pageItems = data.slice(startIndex, endIndex);
                    tbody.innerHTML = "";
                    pageItems.forEach(u => {
                        const tr = document.createElement("tr");
                        tr.className = "hover:bg-slate-50 transition";
                        tr.setAttribute("data-user-id", u.id);
                        const createdDate = parseISO(u.created);
                        const createdDisplay = createdDate ? createdDate.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" }) : "-";
                        tr.innerHTML = `
                            <td class="px-6 py-4">
                                <input type="checkbox" class="row-checkbox rounded">
                            </td>
                            <td class="px-6 py-4 flex items-center gap-3">
                                <img src="${u.avatar}" class="w-10 h-10 rounded-full object-cover">
                                <span class="font-semibold text-slate-800">${u.name}</span>
                            </td>
                            <td class="px-6 py-4 text-slate-500">${u.email}</td>
                            <td class="px-6 py-4 text-slate-500">${createdDisplay}</td>
                            <td class="px-6 py-4 text-start">
                                <span class="bg-pink-100 text-pink-600 px-3 py-1 rounded-md text-xs font-bold">${u.role}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="${u.status === "Active" ? "bg-green-500" : "bg-red-500"} text-white px-3 py-1 rounded-md text-[10px] font-medium">
                                    <i class="fas fa-circle text-[3px] mr-1"></i> ${u.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end gap-3 text-slate-400">
                                    <button class="hover:text-slate-600"><i class="fas fa-shield-halved"></i></button>
                                    <button class="hover:text-blue-500 edit-user-btn"><i class="fas fa-pen"></i></button>
                                    <button class="hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    const paginationText = document.getElementById("paginationText");
                    const prev = document.getElementById("prevPage");
                    const next = document.getElementById("nextPage");
                    if (paginationText && prev && next) {
                        if (total === 0) {
                            paginationText.textContent = "Showing 0 entries";
                        } else {
                            paginationText.textContent = `Showing ${startIndex + 1} - ${endIndex} of ${total} entries`;
                        }
                        prev.disabled = state.page <= 1;
                        next.disabled = state.page >= totalPages;
                        prev.classList.toggle("opacity-40", prev.disabled);
                        next.classList.toggle("opacity-40", next.disabled);
                    }
                    if (selectAll) selectAll.checked = false;
                });
            }
            setupHeaderSort(thName, "name", "sortDirName");
            setupHeaderSort(thEmail, "email", "sortDirEmail");
            setupHeaderSort(thCreated, "created", "sortDirCreated");
            setupHeaderSort(thPosition, "position", "sortDirPosition");
            setupHeaderSort(thRole, "role", "sortDirRole");
            setupHeaderSort(thStatus, "status", "sortDirStatus");

            if (exportBtn && exportMenu && exportWrapper) {
                exportBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    exportMenu.classList.toggle("hidden");
                });
                document.addEventListener("click", e => {
                    if (!exportWrapper.contains(e.target)) {
                        exportMenu.classList.add("hidden");
                    }
                });
            }

            function exportCurrentToCsv() {
                const filtered = getFilteredData();
                const header = ["Name", "Email", "Created Date", "Role", "Status"];
                const rows = filtered.map(u => [
                    `"${u.name.replace(/"/g, '""')}"`,
                    `"${u.email.replace(/"/g, '""')}"`,
                    `"${u.created}"`,
                    `"${u.role}"`,
                    `"${u.status}"`
                ].join(","));
                const csvContent = [header.join(","), ...rows].join("\n");
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "users-export.csv";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function exportCurrentToPdfLike() {
                const filtered = getFilteredData();
                const win = window.open("", "_blank");
                if (!win) return;
                let html = "<html><head><title>Users Export</title>";
                html += '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">';
                html += "</head><body class='p-4'><h3>Users Export</h3>";
                html += "<table class='table table-bordered table-sm mt-3'><thead><tr>";
                html += "<th>Name</th><th>Email</th><th>Created Date</th><th>Role</th><th>Status</th>";
                html += "</tr></thead><tbody>";
                filtered.forEach(u => {
                    html += "<tr>";
                    html += `<td>${u.name}</td>`;
                    html += `<td>${u.email}</td>`;
                    html += `<td>${u.created}</td>`;
                    html += `<td>${u.role}</td>`;
                    html += `<td>${u.status}</td>`;
                    html += "</tr>";
                });
                html += "</tbody></table></body></html>";
                win.document.write(html);
                win.document.close();
                win.focus();
            }

            if (exportPdf) {
                exportPdf.addEventListener("click", () => {
                    exportCurrentToPdfLike();
                    if (exportMenu) exportMenu.classList.add("hidden");
                });
            }
            if (exportExcel) {
                exportExcel.addEventListener("click", () => {
                    exportCurrentToCsv();
                    if (exportMenu) exportMenu.classList.add("hidden");
                });
            }

            if (customApply && customStart && customEnd && customOverlay) {
                customApply.addEventListener("click", () => {
                    const s = customStart.value;
                    const e = customEnd.value;
                    if (s && e) {
                        state.customStart = s;
                        state.customEnd = e;
                        state.datePreset = "custom";
                        state.page = 1;
                        renderTable();
                    }
                    customOverlay.classList.add("hidden");
                });
            }
            if (customCancel && customOverlay) {
                customCancel.addEventListener("click", () => {
                    customOverlay.classList.add("hidden");
                    const filterDate = document.getElementById("filterDatePreset");
                    if (filterDate) {
                        filterDate.value = state.datePreset || "last90";
                    }
                });
            }

            const tbody = document.getElementById("usersTableBody");
            if (tbody) {
                tbody.addEventListener("click", e => {
                    const btn = e.target.closest(".edit-user-btn");
                    if (!btn) return;
                    const tr = btn.closest("tr");
                    if (!tr) return;
                    const userId = tr.getAttribute("data-user-id");
                    if (!userId) return;
                    openEditUserModal(userId);
                });
            }

            if (editClose && editOverlay) {
                editClose.addEventListener("click", () => {
                    editOverlay.classList.add("hidden");
                    editingUserId = null;
                });
            }
            if (editCancel && editOverlay) {
                editCancel.addEventListener("click", () => {
                    editOverlay.classList.add("hidden");
                    editingUserId = null;
                });
            }
            if (editSave) {
                editSave.addEventListener("click", () => {
                    saveEditUser();
                });
            }
            if (togglePass) {
                togglePass.addEventListener("click", () => {
                    const input = document.getElementById("editPassword");
                    if (!input) return;
                    if (input.type === "password") {
                        input.type = "text";
                        togglePass.innerHTML = '<i class="fas fa-eye"></i>';
                    } else {
                        input.type = "password";
                        togglePass.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    }
                });
            }

            if (deleteCancel && deleteOverlay) {
                deleteCancel.addEventListener("click", () => {
                    deletingUserId = null;
                    deleteOverlay.classList.add("hidden");
                });
            }
            if (deleteConfirm && deleteOverlay) {
                deleteConfirm.addEventListener("click", async () => {
                    if (!deletingUserId) return;
                    try {
                        await deleteDoc(doc(db, "users", deletingUserId));
                        deletingUserId = null;
                        deleteOverlay.classList.add("hidden");
                        await loadUsers();
                    } catch (e) {
                        console.error("Failed to delete user", e);
                        alert("Gagal menghapus user.");
                    }
                });
            }

            if (addButton) {
                addButton.addEventListener("click", () => {
                    openAddUserModal();
                });
            }
            if (addClose && addOverlay) {
                addClose.addEventListener("click", () => {
                    addOverlay.classList.add("hidden");
                    addingUser = false;
                });
            }
            if (addCancel && addOverlay) {
                addCancel.addEventListener("click", () => {
                    addOverlay.classList.add("hidden");
                    addingUser = false;
                });
            }
            if (addSave) {
                addSave.addEventListener("click", () => {
                    saveAddUser();
                });
            }
            if (toggleAddPass) {
                toggleAddPass.addEventListener("click", () => {
                    const input = document.getElementById("addPassword");
                    if (!input) return;
                    if (input.type === "password") {
                        input.type = "text";
                        toggleAddPass.innerHTML = '<i class="fas fa-eye"></i>';
                    } else {
                        input.type = "password";
                        toggleAddPass.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    }
                });
            }
        }

        renderTable();
        setupControls();
    </script>

</body>
</html>
