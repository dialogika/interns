<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Internship - Team Dialogika</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="../assets/css/style.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #fdfeff;
            color: #0f172a;
        }
        .premium-shadow { box-shadow: 0 10px 40px -10px rgba(0,0,0,0.04); }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
        .active-pulse {
            position: relative;
            display: inline-block;
            width: 8px; height: 8px;
            background: #10b981; border-radius: 50%;
        }
        .active-pulse::after {
            content: '';
            position: absolute; width: 100%; height: 100%;
            background: #10b981; border-radius: 50%;
            animation: pulse 2s infinite; opacity: 0.5;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(3); opacity: 0; } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
    <body class="antialiased" style="background-color:#f1f7fd;">

    <div id="topbarContainer"></div>
    
    <div class="dashboard-container">
        
        <div id="sidebarContainer"></div>

        <main class="main-content">
    <div class="ml-20 p-8 md:p-12 lg:p-16 max-w-[1600px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-12 gap-6">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="active-pulse"></span>
                    <span class="text-xs font-bold tracking-[0.2em] text-slate-400 uppercase">Rekap Kehadiran Internship</span>
                </div>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">
                    Presensi Internship
                    <span class="text-[#0B2B6A] text-base align-middle" id="subtitleText">Live recap</span>
                </h1>
            </div>
            <div class="flex flex-col items-stretch gap-3">
                <div class="flex items-center gap-2 bg-slate-100/60 p-1.5 rounded-2xl border border-slate-200">
                    <input type="date" id="filterDate" class="flex-1 px-3 py-2 rounded-xl text-xs border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-[#0B2B6A]">
                    <button id="btnClearFilter" class="px-4 py-2 rounded-xl text-xs font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 transition">
                        Reset
                    </button>
                </div>
                <span id="summaryText" class="text-xs text-slate-400 font-medium">Memuat data presensi...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mb-12">
            <div class="glass p-6 rounded-3xl premium-shadow flex items-center justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-semibold tracking-wide uppercase mb-1">Total Presensi</p>
                    <p class="text-3xl font-extrabold" id="totalLogsDisplay">0</p>
                </div>
                <div class="w-10 h-10 rounded-2xl bg-[#0B2B6A]/10 flex items-center justify-center text-[#0B2B6A]">
                    <i class="fa-solid fa-clipboard-check text-lg"></i>
                </div>
            </div>
            <div class="glass p-6 rounded-3xl premium-shadow flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="mostDiligentAvatar" class="w-10 h-10 rounded-2xl bg-slate-200 bg-cover bg-center border border-white shadow-sm"></div>
                    <div>
                        <p class="text-slate-500 text-xs font-semibold tracking-wide uppercase mb-1">Intern Terajin</p>
                        <p class="text-sm font-semibold text-slate-700" id="mostDiligentName">-</p>
                    </div>
                </div>
                <div class="w-10 h-10 rounded-2xl bg-amber-50 flex items-center justify-center text-amber-600">
                    <i class="fa-solid fa-calendar-day text-lg"></i>
                </div>
            </div>
            <div class="glass p-6 rounded-3xl premium-shadow flex items-center justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-semibold tracking-wide uppercase mb-1">Tidak Hadir</p>
                    <p class="text-3xl font-extrabold" id="absentCountDisplay">0</p>
                </div>
                <div class="w-10 h-10 rounded-2xl bg-emerald-50 flex items-center justify-center text-emerald-600">
                    <i class="fa-solid fa-user-xmark text-lg"></i>
                </div>
            </div>
            <div class="glass p-6 rounded-3xl premium-shadow hidden lg:flex items-center justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-semibold tracking-wide uppercase mb-1">Persentase Hari Ini</p>
                    <p class="text-3xl font-extrabold" id="attendancePercentDisplay">0%</p>
                </div>
                <div class="w-10 h-10 rounded-2xl bg-slate-900 flex items-center justify-center text-white">
                    <i class="fa-solid fa-circle-info text-lg"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-10">
            <section class="xl:col-span-8 glass rounded-[40px] premium-shadow overflow-hidden">
                <div class="px-8 py-6 flex justify-between items-center border-b border-slate-100/60">
                    <div>
                        <h2 class="text-lg font-bold text-slate-900">Attendance Monitoring Matrix</h2>
                        <p class="text-xs text-slate-400 font-medium">Log kehadiran individual berdasarkan tanggal dan waktu</p>
                    </div>
                    <div id="loadingSpinner" class="w-5 h-5 border-2 border-[#0B2B6A] border-t-transparent rounded-full animate-spin"></div>
                </div>
                <div class="p-4 overflow-x-auto scrollbar-hide">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-slate-400 text-[11px] font-extrabold uppercase tracking-[0.2em]">
                                <th class="px-8 py-3">Member Team</th>
                                <th class="px-4 py-3 text-center" id="matrixDateCol1">-</th>
                                <th class="px-4 py-3 text-center" id="matrixDateCol2">-</th>
                                <th class="px-4 py-3 text-center" id="matrixDateCol3">-</th>
                                <th class="px-4 py-3 text-center" id="matrixDateCol4">-</th>
                                <th class="px-8 py-3 text-right">Activity</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceBody" class="text-slate-600 text-sm">
                        </tbody>
                    </table>
                    <div class="mt-4 flex items-center justify-between">
                        <p id="emptyState" class="text-xs text-slate-400 hidden">Belum ada data presensi.</p>
                        <button id="btnShowAllMatrix" class="ml-auto px-3 py-1.5 text-[11px] font-semibold text-slate-600 border border-slate-200 rounded-full hover:bg-slate-50 transition">
                            Show All
                        </button>
                    </div>
                </div>
            </section>

            <div class="xl:col-span-4 space-y-10">
                <div class="glass p-8 rounded-[40px] premium-shadow">
                    <h3 class="text-lg font-bold mb-6 text-[#0B2B6A]">Attendance Trend</h3>
                    <canvas id="eliteChart" height="200"></canvas>
                </div>
                <div class="glass p-8 rounded-[40px] premium-shadow">
                    <h3 class="text-lg font-bold mb-6 text-[#0B2B6A]">Top Performers</h3>
                    <div id="topPerformersList" class="space-y-6"></div>
                    <button class="w-full mt-8 py-3 bg-slate-900 text-white rounded-2xl text-xs font-bold uppercase tracking-widest hover:bg-[#0B2B6A] transition-colors">View Ranking</button>
                </div>
            </div>
        </div>

        
    </div>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { renderTopBar } from "../element/topbar.js";
        import { renderSidebar } from "../element/sidebar.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5",
            measurementId: "G-SXN811P3N0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const topbarTarget = document.getElementById("topbarContainer");
        if (topbarTarget) {
            renderTopBar(topbarTarget);
        }
        const sidebarTarget = document.getElementById("sidebarContainer");
        if (sidebarTarget) {
            renderSidebar(sidebarTarget);
        }

        const tbody = document.getElementById('attendanceBody');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const emptyState = document.getElementById('emptyState');
        const summaryText = document.getElementById('summaryText');
        const subtitleText = document.getElementById('subtitleText');
        const filterDateInput = document.getElementById('filterDate');
        const btnClearFilter = document.getElementById('btnClearFilter');
        const totalLogsDisplay = document.getElementById('totalLogsDisplay');
        const mostDiligentAvatar = document.getElementById('mostDiligentAvatar');
        const mostDiligentName = document.getElementById('mostDiligentName');
        const absentCountDisplay = document.getElementById('absentCountDisplay');
        const attendancePercentDisplay = document.getElementById('attendancePercentDisplay');
        const topPerformersList = document.getElementById('topPerformersList');
        const btnShowAllMatrix = document.getElementById('btnShowAllMatrix');
        const matrixDateCols = [
            document.getElementById('matrixDateCol1'),
            document.getElementById('matrixDateCol2'),
            document.getElementById('matrixDateCol3'),
            document.getElementById('matrixDateCol4')
        ];

        let allRecords = [];
        let eliteChartInstance = null;
        let showAllMatrix = false;

        function getTodayKey() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, "0");
            const d = String(now.getDate()).padStart(2, "0");
            return y + "-" + m + "-" + d;
        }

        function isValidAttendanceDay(dateStr) {
            if (!dateStr) return false;
            const d = new Date(dateStr + "T00:00:00");
            const day = d.getDay();
            return day === 0 || day === 2 || day === 4 || day === 6;
        }

        function getDayLabel(dateStr) {
            if (!dateStr) return "-";
            const d = new Date(dateStr + "T00:00:00");
            const names = ["Min", "Sen", "Sel", "Rab", "Kam", "Jum", "Sab"];
            const day = d.getDay();
            const dayNum = String(d.getDate()).padStart(2, "0");
            return names[day] + " (" + dayNum + ")";
        }

        function getFirstName(name) {
            if (!name) return "";
            const parts = String(name).trim().split(" ");
            return parts[0] || "";
        }

        function normalizeCreatedAt(raw) {
            if (!raw) return null;
            if (typeof raw.toDate === "function") {
                return raw.toDate();
            }
            if (raw.seconds) {
                return new Date(raw.seconds * 1000);
            }
            if (typeof raw === "string" || typeof raw === "number") {
                const d = new Date(raw);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        function parseTimeOfDay(timeStr) {
            if (!timeStr) return null;
            const parts = String(timeStr).split(":");
            if (!parts.length) return null;
            const h = parseInt(parts[0], 10) || 0;
            const m = parseInt(parts[1] || "0", 10) || 0;
            const s = parseInt(parts[2] || "0", 10) || 0;
            return h * 3600 + m * 60 + s;
        }

        function updateKpis(selectedKey) {
            const todayKey = selectedKey || getTodayKey();
            const userSet = new Set();
            allRecords.forEach(r => {
                if (r.user_id) userSet.add(r.user_id);
            });
            const allUsers = userSet.size;
            const todayRecords = allRecords.filter(r => r.date === todayKey);
            const todayUsers = new Set();
            todayRecords.forEach(r => {
                if (r.user_id) todayUsers.add(r.user_id);
            });
            const presentCount = todayUsers.size;
            if (totalLogsDisplay) {
                totalLogsDisplay.textContent = String(presentCount);
            }
            if (absentCountDisplay) {
                const absent = allUsers > presentCount ? allUsers - presentCount : 0;
                absentCountDisplay.textContent = String(absent);
            }
            if (attendancePercentDisplay) {
                let percent = 0;
                if (allUsers) {
                    percent = Math.round((presentCount / allUsers) * 100);
                }
                attendancePercentDisplay.textContent = String(percent) + "%";
            }
            if (summaryText) {
                if (!allRecords.length) {
                    summaryText.textContent = "Tidak ada data presensi.";
                } else {
                    summaryText.textContent = "Hari ini: " + presentCount + " dari " + allUsers + " intern hadir.";
                }
            }
            if (subtitleText) {
                subtitleText.textContent = "Rekap " + todayKey;
            }
        }

        function updateMostDiligent(selectedKey) {
            if (!mostDiligentAvatar || !mostDiligentName) return;
            const baseDate = selectedKey ? new Date(selectedKey + "T00:00:00") : new Date();
            const start = new Date(baseDate.getTime());
            start.setDate(start.getDate() - 30);
            const counts = new Map();
            allRecords.forEach(r => {
                if (!r.date || !r.user_id) return;
                if (!isValidAttendanceDay(r.date)) return;
                const d = new Date(r.date + "T00:00:00");
                if (d < start || d > baseDate) return;
                const key = r.user_id;
                const existing = counts.get(key) || { count: 0, name: r.name || "", photo: r.photo || "" };
                existing.count += 1;
                if (!existing.name && r.name) existing.name = r.name;
                if (!existing.photo && r.photo) existing.photo = r.photo;
                counts.set(key, existing);
            });
            if (!counts.size) {
                mostDiligentAvatar.style.backgroundImage = "";
                mostDiligentName.textContent = "-";
                return;
            }
            const ranked = Array.from(counts.entries()).sort((a, b) => b[1].count - a[1].count);
            const best = ranked[0][1];
            const firstName = getFirstName(best.name || "Intern");
            mostDiligentName.textContent = firstName || "Intern";
            if (best.photo) {
                mostDiligentAvatar.style.backgroundImage = "url(" + best.photo + ")";
            } else {
                const url = "https://ui-avatars.com/api/?name=" + encodeURIComponent(firstName || "Intern") + "&background=0B2B6A&color=fff";
                mostDiligentAvatar.style.backgroundImage = "url(" + url + ")";
            }
        }

        function updateMatrix(selectedKey) {
            tbody.innerHTML = "";
            const todayKey = selectedKey || getTodayKey();
            const validDateSet = new Set();
            allRecords.forEach(r => {
                if (!r.date) return;
                if (!isValidAttendanceDay(r.date)) return;
                if (r.date <= todayKey) {
                    validDateSet.add(r.date);
                }
            });
            const sortedDates = Array.from(validDateSet).sort();
            const recentDates = sortedDates.slice(-4);
            matrixDateCols.forEach((el, idx) => {
                if (!el) return;
                const dateStr = recentDates[idx];
                el.textContent = dateStr ? getDayLabel(dateStr) : "-";
            });
            if (!recentDates.length) {
                emptyState.classList.remove("hidden");
                return;
            }
            emptyState.classList.add("hidden");
            const usersMap = new Map();
            allRecords.forEach(r => {
                if (!r.date) return;
                if (!recentDates.includes(r.date)) return;
                const key = r.user_id || r.name || r.id;
                if (!key) return;
                const timeValue = parseTimeOfDay(r.time);
                let entry = usersMap.get(key);
                if (!entry) {
                    entry = {
                        user_id: r.user_id || "",
                        name: r.name || "Tanpa Nama",
                        photo: r.photo || "",
                        earliestTimeValue: timeValue != null ? timeValue : null,
                        byDate: {}
                    };
                    usersMap.set(key, entry);
                }
                if (timeValue != null && (entry.earliestTimeValue == null || timeValue < entry.earliestTimeValue)) {
                    entry.earliestTimeValue = timeValue;
                }
                const dateKey = r.date;
                const existingForDate = entry.byDate[dateKey];
                if (!existingForDate || (timeValue != null && timeValue < existingForDate.timeValue)) {
                    entry.byDate[dateKey] = {
                        timeValue: timeValue,
                        time: r.time || ""
                    };
                }
            });
            const entries = Array.from(usersMap.values()).filter(e => e.earliestTimeValue != null);
            entries.sort((a, b) => a.earliestTimeValue - b.earliestTimeValue);
            const rows = showAllMatrix ? entries : entries.slice(0, 5);
            if (!rows.length) {
                emptyState.classList.remove("hidden");
                return;
            }
            emptyState.classList.add("hidden");
            rows.forEach(entry => {
                const tr = document.createElement("tr");
                tr.className = "group hover:bg-[#0B2B6A]/5 transition-colors duration-200";
                const tdUser = document.createElement("td");
                tdUser.className = "px-8 py-4";
                const wrapper = document.createElement("div");
                wrapper.className = "flex items-center gap-4";
                const avatar = document.createElement("div");
                avatar.className = "w-10 h-10 rounded-full bg-slate-200 overflow-hidden border-2 border-white bg-cover bg-center";
                if (entry.photo) {
                    avatar.style.backgroundImage = "url(" + entry.photo + ")";
                }
                const info = document.createElement("div");
                const nameP = document.createElement("p");
                nameP.className = "text-sm font-bold text-slate-900 group-hover:text-[#0B2B6A] transition line-clamp-2";
                nameP.textContent = entry.name;
                info.appendChild(nameP);
                wrapper.appendChild(avatar);
                wrapper.appendChild(info);
                tdUser.appendChild(wrapper);
                tr.appendChild(tdUser);
                let attendedCount = 0;
                recentDates.forEach(dateKey => {
                    const td = document.createElement("td");
                    td.className = "px-4 py-4";
                    const cellWrapper = document.createElement("div");
                    cellWrapper.className = "mx-auto w-3 h-3 rounded-full";
                    const infoForDate = entry.byDate[dateKey];
                    if (infoForDate) {
                        cellWrapper.classList.add("bg-[#0B2B6A]");
                        cellWrapper.style.boxShadow = "0 0 10px rgba(11,43,106,0.5)";
                        td.title = infoForDate.time || "";
                        attendedCount += 1;
                    } else {
                        cellWrapper.classList.add("bg-slate-200");
                    }
                    td.appendChild(cellWrapper);
                    tr.appendChild(td);
                });
                const tdActivity = document.createElement("td");
                tdActivity.className = "px-8 py-4";
                const bar = document.createElement("div");
                bar.className = "w-24 h-1.5 bg-slate-100 rounded-full ml-auto overflow-hidden";
                const fill = document.createElement("div");
                fill.className = "h-full bg-[#0B2B6A]";
                const percent = recentDates.length ? Math.round((attendedCount / recentDates.length) * 100) : 0;
                fill.style.width = String(percent) + "%";
                bar.appendChild(fill);
                tdActivity.appendChild(bar);
                tr.appendChild(tdActivity);
                tbody.appendChild(tr);
            });
        }

        function updateChart(selectedKey) {
            if (typeof Chart === "undefined") return;
            const canvas = document.getElementById("eliteChart");
            if (!canvas) return;
            const todayKey = selectedKey || getTodayKey();
            const validDateSet = new Set();
            allRecords.forEach(r => {
                if (!r.date) return;
                if (!isValidAttendanceDay(r.date)) return;
                if (r.date <= todayKey) {
                    validDateSet.add(r.date);
                }
            });
            const sortedDates = Array.from(validDateSet).sort();
            const chartDates = sortedDates.slice(-8);
            const labels = chartDates.map(d => getDayLabel(d));
            const data = chartDates.map(dateStr => {
                const ids = new Set();
                allRecords.forEach(r => {
                    if (r.date === dateStr && r.user_id) {
                        ids.add(r.user_id);
                    }
                });
                return ids.size;
            });
            const ctx = canvas.getContext("2d");
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, "rgba(11, 43, 106, 0.4)");
            gradient.addColorStop(1, "rgba(11, 43, 106, 0)");
            if (eliteChartInstance) {
                eliteChartInstance.destroy();
            }
            eliteChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Kehadiran",
                            data: data,
                            borderColor: "#0B2B6A",
                            borderWidth: 4,
                            pointBackgroundColor: "#fff",
                            pointBorderColor: "#0B2B6A",
                            pointBorderWidth: 3,
                            pointRadius: 6,
                            fill: true,
                            backgroundColor: gradient,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, beginAtZero: true },
                        x: { grid: { display: false }, border: { display: false } }
                    }
                }
            });
        }

        function updateTopPerformers(selectedKey) {
            if (!topPerformersList) return;
            topPerformersList.innerHTML = "";
            const baseDate = selectedKey ? new Date(selectedKey + "T00:00:00") : new Date();
            const start = new Date(baseDate.getTime());
            start.setDate(start.getDate() - 30);
            const earliestByDate = new Map();
            allRecords.forEach(r => {
                if (!r.date || !r.user_id) return;
                if (!isValidAttendanceDay(r.date)) return;
                const d = new Date(r.date + "T00:00:00");
                if (d < start || d > baseDate) return;
                const createdAt = r.createdAt || normalizeCreatedAt(r.created_at);
                if (!createdAt) return;
                const key = r.date;
                const existing = earliestByDate.get(key);
                if (!existing || createdAt < existing.createdAt) {
                    earliestByDate.set(key, {
                        createdAt: createdAt,
                        record: r
                    });
                }
            });
            const scoreMap = new Map();
            earliestByDate.forEach(v => {
                const r = v.record;
                const key = r.user_id;
                const existing = scoreMap.get(key) || { count: 0, name: r.name || "", photo: r.photo || "" };
                existing.count += 1;
                if (!existing.name && r.name) existing.name = r.name;
                if (!existing.photo && r.photo) existing.photo = r.photo;
                scoreMap.set(key, existing);
            });
            if (!scoreMap.size) {
                const p = document.createElement("p");
                p.className = "text-xs text-slate-400";
                p.textContent = "Belum ada data top performers untuk 1 bulan terakhir.";
                topPerformersList.appendChild(p);
                return;
            }
            const ranked = Array.from(scoreMap.entries()).sort((a, b) => b[1].count - a[1].count);
            const topThree = ranked.slice(0, 3);
            topThree.forEach((entry, index) => {
                const data = entry[1];
                const wrapper = document.createElement("div");
                wrapper.className = "flex items-center justify-between";
                const left = document.createElement("div");
                left.className = "flex items-center gap-3";
                const badge = document.createElement("div");
                badge.className = "w-8 h-8 rounded-full text-[10px] flex items-center justify-center font-bold";
                if (index === 0) {
                    badge.classList.add("bg-[#0B2B6A]", "text-white");
                } else {
                    badge.classList.add("bg-slate-200", "text-slate-600");
                }
                badge.textContent = String(index + 1).padStart(2, "0");
                const nameP = document.createElement("p");
                nameP.className = "text-sm font-bold";
                nameP.textContent = data.name || "Intern";
                left.appendChild(badge);
                left.appendChild(nameP);
                const scoreSpan = document.createElement("span");
                scoreSpan.className = "text-xs font-bold text-emerald-500";
                scoreSpan.textContent = String(data.count) + "x paling awal";
                wrapper.appendChild(left);
                wrapper.appendChild(scoreSpan);
                topPerformersList.appendChild(wrapper);
            });
        }

        function updateDashboard() {
            if (!allRecords.length) {
                if (emptyState) emptyState.classList.remove("hidden");
                if (summaryText) summaryText.textContent = "Tidak ada data presensi.";
                if (totalLogsDisplay) totalLogsDisplay.textContent = "0";
                if (absentCountDisplay) absentCountDisplay.textContent = "0";
                if (attendancePercentDisplay) attendancePercentDisplay.textContent = "0%";
                if (topPerformersList) topPerformersList.innerHTML = "";
                return;
            }
            const selectedKey = filterDateInput && filterDateInput.value ? filterDateInput.value : getTodayKey();
            if (filterDateInput && !filterDateInput.value) {
                filterDateInput.value = selectedKey;
            }
            updateKpis(selectedKey);
            updateMostDiligent(selectedKey);
            updateMatrix(selectedKey);
            updateChart(selectedKey);
            updateTopPerformers(selectedKey);
        }

        async function loadAttendance() {
            if (filterDateInput && !filterDateInput.value) {
                filterDateInput.value = getTodayKey();
            }
            if (loadingSpinner) {
                loadingSpinner.classList.remove("hidden");
            }
            try {
                const q = query(collection(db, "user_attendance"), orderBy("created_at", "desc"));
                const snap = await getDocs(q);
                const rows = [];
                snap.forEach(docSnap => {
                    const d = docSnap.data() || {};
                    const createdAt = normalizeCreatedAt(d.created_at);
                    rows.push({
                        id: docSnap.id,
                        user_id: d.user_id || "",
                        name: d.name || "",
                        photo: d.photo || "",
                        date: d.date || "",
                        time: d.time || "",
                        createdAt: createdAt,
                        created_at: d.created_at || null
                    });
                });
                allRecords = rows;
                updateDashboard();
            } catch (e) {
                console.error("Gagal memuat data presensi", e);
                if (summaryText) {
                    summaryText.textContent = "Gagal memuat data presensi.";
                }
            } finally {
                if (loadingSpinner) {
                    loadingSpinner.classList.add("hidden");
                }
            }
        }

        if (filterDateInput) {
            filterDateInput.addEventListener("change", () => {
                updateDashboard();
            });
        }

        if (btnClearFilter) {
            btnClearFilter.addEventListener("click", () => {
                if (filterDateInput) {
                    filterDateInput.value = getTodayKey();
                }
                updateDashboard();
            });
        }

        if (btnShowAllMatrix) {
            btnShowAllMatrix.addEventListener("click", () => {
                showAllMatrix = !showAllMatrix;
                btnShowAllMatrix.textContent = showAllMatrix ? "Show Top 5" : "Show All";
                updateMatrix(filterDateInput && filterDateInput.value ? filterDateInput.value : getTodayKey());
            });
        }

        loadAttendance();
    </script>
</body>
</html>
